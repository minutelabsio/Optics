define(["jquery","raphael","modules/link-scroller"],function(e,t,n){function r(e,t,n,i,s,o){if(s===undefined){var u=n-e,a=i-t;return!u&&!a?0:(Math.atan2(a,u)*180/Math.PI+360)%360}return(r(e,t,n,i)-r(n,i,s,o)+180+360)%360}n(".scrolling-link");if(!Modernizr.svg)return;e(function(){function l(e,t){var n=Math.abs(t.y-e.y),r=Math.abs(t.x-e.x),i=1e-6;return n<i&&r<i}function c(e,n,u,a){var f=t.transformPath("M"+[e,n].join(",")+"L"+[e,n-i].join(","),"r"+u+","+[e,n].join(",")),h=t.pathIntersection(f,o),p,d;a=a||{points:[],strs:[]};if(h.length===0)return a;if(a.points.length){for(var v=0,m=h.length;v<m;++v)if(!l(h[v],a.points[a.points.length-1])){h=h[v];break}if(h.length)return a}else h=h[0];return l({x:s[0],y:s[1]},h)?(a.points.push({x:h.x,y:h.y,ang:180+u}),a.strs.push(h.x+","+h.y),a):(p=180-r(e,n,h.x,h.y,s[0],s[1]),d=90-r(h.x,-h.y,s[0],-s[1]),p+=d,a.points.push({x:h.x,y:h.y,ang:p}),a.strs.push(h.x+","+h.y),c(h.x,h.y,p,a))}function N(){return""}function C(){var e=c(m.x,m.y,v);p&&p.remove();if(e.points.length){var r=e.points.length,s=e.points[r-1],o=i*Math.sin(t.rad(s.ang))+s.x,u=-i*Math.cos(t.rad(s.ang))+s.y;p=n.path("M"+m.x+","+m.y+"L"+e.strs.join("L")+"L"+[o,u].join(",")).attr(T)}else d=t.transformPath("M"+m.x+","+m.y+"L"+m.x+","+(m.y-i),"r"+v+","+m.x+","+m.y),p=n.path(d).attr(T)}var n=t("svg-wrap"),i=999,s=[20,20],o="M20,300L"+s.join(",")+"L300,20",u=n.path(o).attr({stroke:"#333","stroke-width":5,"stroke-linecap":"round","stroke-linejoin":"round"}),a=10,f="";for(var h=300;h>10;h-=10)f+="M20,"+h+"L10,"+(h-10),f+="M"+h+",20L"+(h-10)+",10";n.path(f).attr({stroke:"#888","stroke-width":2,"stroke-linecap":"round"}).toBack();var p,d,v=-57,m={x:380,y:350},g=e("#svg-wrap").offset(),y=e("#instructions"),b,w,E,S=n.text(m.x-70,m.y+40,N()),x=n.set().push(E=n.circle(m.x,m.y,120).attr({stroke:"#bbb","stroke-dasharray":"--",fill:"#883","fill-opacity":0}),w=n.rect(m.x-15,m.y,30,80,2).attr({stroke:"#3aa",fill:"#3aa","fill-opacity":.5,cursor:"move"}),b=n.ellipse(m.x,m.y+120,20,8).attr({fill:"#883",stroke:"#883","fill-opacity":.5,"stroke-width":2,cursor:"url(library/images/cursor-rotate.png) 8 8"})),T={stroke:"#c00","stroke-width":3,"stroke-linejoin":"bevel"};g.width=e("#svg-wrap").innerWidth(),g.height=e("#svg-wrap").innerHeight(),y.length?(y={x:y.offset().left-g.left,y:y.offset().top-g.top,width:y.outerWidth(),height:y.outerHeight()},y.x2=y.x+y.width,y.y2=y.y+y.height):y=!1,x.transform("r"+v+","+m.x+","+m.y),S.transform("r"+v+","+m.x+","+m.y+"r"+ -v),C(),b.drag(function(e,t,i,s){var o=i-g.left,u=s-g.top;v=280+r(m.x,m.y,o,u),x.transform("r"+v+","+m.x+","+m.y),S.transform("r"+v+","+m.x+","+m.y+"r"+ -v),S.attr("text",N()),C(),n.safari()},function(){e("body").addClass("rotate")},function(){e("body").removeClass("rotate"),E.animate({"fill-opacity":0},500)}).hover(function(){E.attr({fill:b.attr("fill")}).animate({"fill-opacity":.15},500)},function(){e("body").hasClass("rotate")||E.animate({"fill-opacity":0},500)});var k,L,A,O;w.drag(function(e,t,r,i){var s=x.getBBox();s.y2+t-O>g.height?t=Math.min(O-s.y2+g.height,t):s.y+t-O<0&&(t=Math.max(O-s.y,t)),s.x2+e-A>g.width?e=Math.min(A-s.x2+g.width,e):s.x+e-A<0&&(e=Math.max(A-s.x,e)),y&&s.x2+e-A>y.x&&s.y<y.y2&&s.y2>y.y&&(e=Math.min(A+y.x-s.x2,e)),m.x=k+e,m.y=L+t,x.transform("r"+v+","+m.x+","+m.y+"t"+e+","+t),S.transform("t"+e+","+t),S.attr("text",N()),S.dx=e,S.dy=t,C(),n.safari(),A=e,O=t},function(e,t){k=m.x,L=m.y,x.forEach(function(e){var t=e.type==="rect";e.ox=t?e.attr("x"):e.attr("cx"),e.oy=t?e.attr("y"):e.attr("cy")})},function(){var e=m.x-k,t=m.y-L;x.forEach(function(n){var r=n.type==="rect",i=r?n.attr("x"):n.attr("cx"),s=r?n.attr("y"):n.attr("cy"),o=r?{x:n.ox+e,y:n.oy+t}:{cx:n.ox+e,cy:n.oy+t};n.attr(o)}),x.transform("r"+v+","+m.x+","+m.y),S.transform("t0,0").attr({x:S.attr("x")+S.dx,y:S.attr("y")+S.dy}),n.safari(),E.animate({"fill-opacity":0},500)}).hover(function(){E.attr({fill:w.attr("fill")}).animate({"fill-opacity":.15},500)},function(){e("body").hasClass("rotate")||E.animate({"fill-opacity":0},500)})})});